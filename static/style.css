/* Сброс и базовые стили */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    /* Тёмная тема (по умолчанию) */
    --primary-color: #6366f1;
    --primary-dark: #4f46e5;
    --primary-light: #818cf8;

    --secondary-color: #8b5cf6;
    --success-color: #10b981;
    --danger-color: #ef4444;
    --warning-color: #f59e0b;
    --info-color: #3b82f6;

    --bg-dark: #0f172a;
    --bg-darker: #0a0f1f;
    --bg-card: #1e293b;
    --bg-input: #334155;
    --bg-hover: #2d3748;

    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;

    --border-color: #475569;
    --border-light: #64748b;

    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);

    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --radius-full: 9999px;

    --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

body.light-theme {
    /* Светлая тема */
    --primary-color: #6366f1;
    --primary-dark: #4f46e5;
    --primary-light: #818cf8;

    --secondary-color: #8b5cf6;
    --success-color: #10b981;
    --danger-color: #ef4444;
    --warning-color: #f59e0b;
    --info-color: #3b82f6;

    --bg-dark: #f8fafc;
    --bg-darker: #f1f5f9;
    --bg-card: #ffffff;
    --bg-input: #f1f5f9;
    --bg-hover: #e2e8f0;

    --text-primary: #1e293b;
    --text-secondary: #475569;
    --text-muted: #94a3b8;

    --border-color: #e2e8f0;
    --border-light: #cbd5e1;

    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

body {
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg-dark);
    color: var(--text-primary);
    min-height: 100vh;
    transition: var(--transition);
}

/* Страницы авторизации */
.auth-page {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 1rem;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
}

.auth-container {
    width: 100%;
    max-width: 440px;
}

.auth-card {
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    padding: 2.5rem;
    box-shadow: var(--shadow-lg);
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.auth-header {
    text-align: center;
    margin-bottom: 2rem;
}

.logo {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 1.5rem;
}

.logo i {
    font-size: 2rem;
}

.auth-header h1 {
    font-size: 1.75rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.auth-header p {
    color: var(--text-secondary);
    font-size: 0.9375rem;
}

.alert {
    padding: 1rem;
    border-radius: var(--radius-md);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(-10px); }
    to { opacity: 1; transform: translateX(0); }
}

.alert-error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.2);
    color: #fca5a5;
}

.alert-success {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.2);
    color: #34d399;
}

.alert-info {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
    color: #93c5fd;
}

.auth-form {
    margin-bottom: 2rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
    font-weight: 500;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 0.875rem 1rem;
    background: var(--bg-input);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.9375rem;
    transition: var(--transition);
    font-family: 'Inter', sans-serif;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    background: var(--bg-card);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.form-group input[type="password"] {
    letter-spacing: 0.1em;
}

.input-with-prefix {
    display: flex;
    align-items: center;
}

.input-with-prefix .prefix {
    background: var(--bg-input);
    padding: 0.875rem 1rem;
    border: 2px solid var(--border-color);
    border-right: none;
    border-radius: var(--radius-md) 0 0 var(--radius-md);
    color: var(--text-secondary);
    font-size: 0.9375rem;
    font-weight: 500;
}

.input-with-prefix input {
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
}

.form-hint {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.375rem;
}

.btn {
    padding: 0.875rem 1.5rem;
    border: none;
    border-radius: var(--radius-md);
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-family: 'Inter', sans-serif;
}

.btn-block {
    width: 100%;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    position: relative;
    overflow: hidden;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-primary::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
}

.btn-primary:hover::after {
    left: 100%;
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--border-color);
    color: var(--text-primary);
}

.btn-outline:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
    background: rgba(99, 102, 241, 0.05);
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
    transform: translateY(-2px);
}

.btn-icon {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: var(--radius-full);
    border: none;
    background: var(--bg-input);
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}

.btn-icon:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.auth-footer {
    text-align: center;
    padding-top: 1.5rem;
    margin-top: 1.5rem;
    border-top: 1px solid var(--border-color);
}

.auth-footer p {
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.link {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 500;
    transition: var(--transition);
}

.link:hover {
    text-decoration: underline;
}

.security-info,
.demo-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: var(--bg-input);
    border-radius: var(--radius-md);
    margin-top: 1.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.security-info i {
    color: var(--success-color);
}

.demo-info i {
    color: var(--info-color);
}

/* Чат приложение */
.chat-app {
    display: flex;
    height: 100vh;
    background: var(--bg-dark);
}

/* Боковая панель */
.sidebar {
    width: 380px;
    background: var(--bg-card);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    transition: var(--transition);
}

.sidebar-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.user-profile {
    flex: 1;
}

.user-link {
    display: flex;
    align-items: center;
    gap: 1rem;
    text-decoration: none;
    color: inherit;
    transition: var(--transition);
}

.user-link:hover {
    opacity: 0.9;
}

.user-avatar {
    width: 3rem;
    height: 3rem;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: white;
    font-size: 1.25rem;
    position: relative;
    overflow: hidden;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-info h3 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: var(--text-primary);
}

.user-status {
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    color: var(--text-secondary);
}

.user-status.online {
    color: var(--success-color);
}

.user-status i {
    font-size: 0.5rem;
}

.sidebar-actions {
    display: flex;
    gap: 0.5rem;
}

.search-container {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    position: relative;
}

.search-box {
    position: relative;
    display: flex;
    align-items: center;
}

.search-box i {
    position: absolute;
    left: 1rem;
    color: var(--text-muted);
    font-size: 0.875rem;
}

.search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.75rem;
    background: var(--bg-input);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-full);
    color: var(--text-primary);
    font-size: 0.875rem;
    transition: var(--transition);
}

.search-box input:focus {
    outline: none;
    background: var(--bg-card);
    border-color: var(--primary-color);
}

.search-results {
    position: absolute;
    top: 100%;
    left: 1.5rem;
    right: 1.5rem;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    margin-top: 0.5rem;
    max-height: 320px;
    overflow-y: auto;
    display: none;
    z-index: 1000;
    box-shadow: var(--shadow-lg);
}

.no-results {
    padding: 2rem 1rem;
    text-align: center;
    color: var(--text-muted);
    font-size: 0.875rem;
}

.contacts-container {
    flex: 1;
    overflow-y: auto;
}

.contacts-header {
    padding: 1.25rem 1.5rem 0.75rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.contacts-header h3 {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.badge {
    padding: 0.25rem 0.75rem;
    background: var(--primary-color);
    color: white;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 500;
}

.contacts-list {
    display: flex;
    flex-direction: column;
}

.contact-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    cursor: pointer;
    transition: var(--transition);
    border-bottom: 1px solid var(--border-color);
    position: relative;
}

.contact-item:hover {
    background: var(--bg-hover);
}

.contact-item.active {
    background: var(--bg-input);
    border-left: 3px solid var(--primary-color);
}

.contact-avatar {
    width: 2.75rem;
    height: 2.75rem;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: white;
    font-size: 1rem;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
}

.contact-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.status-indicator {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 0.75rem;
    height: 0.75rem;
    border-radius: var(--radius-full);
    background: var(--text-muted);
    border: 2px solid var(--bg-card);
    transition: var(--transition);
}

.status-indicator.online {
    background: var(--success-color);
    box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
}

.contact-info {
    flex: 1;
    min-width: 0;
}

.contact-name-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.25rem;
}

.contact-name-row h4 {
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.message-time {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.contact-preview {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Область чата */
.chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg-dark);
}

.chat-header {
    padding: 1.5rem 2rem;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.chat-actions {
    display: flex;
    gap: 0.5rem;
}

.empty-chat {
    text-align: center;
    padding: 3rem 1rem;
}

.empty-icon {
    font-size: 4rem;
    color: var(--primary-color);
    opacity: 0.2;
    margin-bottom: 1.5rem;
}

.empty-chat h2 {
    font-size: 1.75rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
}

.empty-chat p {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
    font-size: 1rem;
}

.empty-contacts {
    padding: 3rem 1rem;
    text-align: center;
    color: var(--text-secondary);
}

.empty-contacts .empty-icon {
    font-size: 3rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
    opacity: 0.5;
}

.messages-container {
    flex: 1;
    padding: 1.5rem 2rem;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    background: var(--bg-dark);
}

.message {
    display: flex;
    max-width: 65%;
    animation: messageAppear 0.3s ease;
}

@keyframes messageAppear {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.incoming {
    align-self: flex-start;
}

.message.outgoing {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.message-avatar {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: white;
    font-size: 0.875rem;
    flex-shrink: 0;
    margin-top: auto;
}

.message.incoming .message-avatar {
    margin-right: 0.75rem;
}

.message.outgoing .message-avatar {
    margin-left: 0.75rem;
}

.message-content {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
}

.message-bubble {
    padding: 0.75rem 1rem;
    border-radius: var(--radius-lg);
    font-size: 0.9375rem;
    line-height: 1.4;
    word-break: break-word;
    position: relative;
    max-width: 100%;
}

.message.incoming .message-bubble {
    background: var(--bg-card);
    border-bottom-left-radius: var(--radius-sm);
    color: var(--text-primary);
    box-shadow: var(--shadow-sm);
}

.message.outgoing .message-bubble {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-bottom-right-radius: var(--radius-sm);
    color: white;
}

.message-text {
    word-wrap: break-word;
}

.message-media {
    margin: 0.5rem 0;
    border-radius: var(--radius-md);
    overflow: hidden;
}

.message-media img,
.message-media video {
    max-width: 300px;
    max-height: 300px;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: transform 0.2s ease;
    display: block;
}

.message-media img:hover {
    transform: scale(1.02);
}

.message-media video {
    background: #000;
}

.media-caption {
    margin-top: 0.5rem;
    padding: 0.5rem 0;
    color: inherit;
    font-size: 0.9375rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.message.outgoing .media-caption {
    border-top-color: rgba(255, 255, 255, 0.2);
}

.message-time {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-align: right;
}

.message-input-container {
    padding: 1.5rem 2rem;
    background: var(--bg-card);
    border-top: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.typing-indicator {
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    animation: typingPulse 1.5s infinite;
}

@keyframes typingPulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
}

.message-input-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
}

.attachment-buttons {
    display: flex;
    gap: 0.5rem;
}

#message-form {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
}

#message-input {
    flex: 1;
    padding: 0.875rem 1.25rem;
    background: var(--bg-input);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-full);
    color: var(--text-primary);
    font-size: 0.9375rem;
    transition: var(--transition);
}

#message-input:focus {
    outline: none;
    background: var(--bg-card);
    border-color: var(--primary-color);
}

.btn-send {
    width: 3rem;
    height: 3rem;
    padding: 0;
    border-radius: var(--radius-full);
    font-size: 1.125rem;
}

/* Превью вложений */
.attachment-preview {
    margin-top: 0.5rem;
    padding: 1rem;
    background: var(--bg-input);
    border-radius: var(--radius-md);
    border: 2px dashed var(--border-color);
    display: none;
}

.preview-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

.preview-content {
    flex: 1;
    display: flex;
    gap: 1rem;
    align-items: center;
}

.preview-image img,
.preview-video video {
    max-width: 150px;
    max-height: 150px;
    border-radius: var(--radius-md);
    object-fit: cover;
}

.preview-video video {
    background: #000;
}

.preview-info {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.btn-remove-attachment {
    background: var(--danger-color);
    color: white;
}

.btn-remove-attachment:hover {
    background: #dc2626;
}

/* Модальное окно для звонков */
.call-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.9);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.call-modal-content {
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    width: 90%;
    max-width: 500px;
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    animation: modalAppear 0.3s ease;
}

@keyframes modalAppear {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

.call-modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    text-align: center;
}

.call-modal-header h3 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
}

#call-timer {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-left: 0.5rem;
}

.call-modal-body {
    padding: 2rem 1.5rem;
    text-align: center;
}

.calling-animation {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
}

.calling-dots {
    display: flex;
    gap: 0.5rem;
}

.calling-dots .dot {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
    background: var(--primary-color);
    animation: dotPulse 1.4s ease-in-out infinite;
}

.calling-dots .dot:nth-child(1) { animation-delay: -0.32s; }
.calling-dots .dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes dotPulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
}

.incoming-call {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
}

.caller-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.caller-avatar {
    width: 5rem;
    height: 5rem;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: 600;
    color: white;
}

.caller-details {
    text-align: center;
}

.caller-details h4 {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
}

.caller-details p {
    color: var(--text-secondary);
}

.video-container {
    position: relative;
    width: 100%;
    height: 300px;
    margin: 1rem 0;
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--bg-darker);
}

#local-video {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    width: 120px;
    height: 90px;
    border-radius: var(--radius-md);
    object-fit: cover;
    border: 2px solid var(--border-color);
    z-index: 1;
}

#remote-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.call-controls {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 1rem;
}

.call-controls .btn-icon {
    width: 3.5rem;
    height: 3.5rem;
    font-size: 1.25rem;
}

.call-controls .btn-danger {
    background: var(--danger-color);
    color: white;
}

.call-controls .btn-danger:hover {
    background: #dc2626;
}

.active-call {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.active-call p {
    font-size: 1.125rem;
    color: var(--text-primary);
}

.call-modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: center;
    gap: 1rem;
}

/* Просмотрщик медиа */
.media-viewer {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.media-viewer-content {
    position: relative;
    max-width: 90%;
    max-height: 90%;
}

.media-viewer-content img,
.media-viewer-content video {
    max-width: 100%;
    max-height: 90vh;
    border-radius: var(--radius-lg);
}

.media-viewer-content video {
    background: #000;
}

.close-viewer {
    position: absolute;
    top: -3rem;
    right: 0;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    width: 3rem;
    height: 3rem;
    border-radius: var(--radius-full);
    font-size: 1.5rem;
    cursor: pointer;
    transition: var(--transition);
}

.close-viewer:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* Страница профиля */
.profile-page {
    min-height: 100vh;
    background: var(--bg-dark);
    padding: 1rem;
}

.profile-nav {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 2rem;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
}

.back-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.9375rem;
    font-weight: 500;
    transition: var(--transition);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
}

.back-btn:hover {
    color: var(--primary-color);
    background: var(--bg-input);
}

.profile-nav h1 {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--text-primary);
}

.profile-content {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 1.5rem;
    max-width: 1200px;
    margin: 0 auto;
}

.profile-card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    transition: var(--transition);
}

.profile-card:hover {
    box-shadow: var(--shadow-md);
}

.avatar-section {
    text-align: center;
    margin-bottom: 1.5rem;
}

.avatar-preview {
    width: 8rem;
    height: 8rem;
    border-radius: var(--radius-full);
    margin: 0 auto 1rem;
    border: 4px solid var(--primary-color);
    overflow: hidden;
    position: relative;
}

.avatar-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    font-weight: 600;
    color: white;
}

.avatar-actions {
    display: flex;
    justify-content: center;
    gap: 0.75rem;
    margin-top: 1rem;
}

.user-info {
    text-align: center;
    margin-bottom: 1.5rem;
}

.user-info h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.username {
    color: var(--text-secondary);
    font-size: 0.9375rem;
    margin-bottom: 1rem;
}

.description {
    color: var(--text-primary);
    font-size: 0.9375rem;
    line-height: 1.5;
    margin-bottom: 1.5rem;
}

.user-stats {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 1.5rem;
}

.stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: var(--bg-input);
    border-radius: var(--radius-md);
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.stat-value {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
}

/* Настройки темы */
.theme-selector {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-top: 1rem;
}

.theme-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition);
}

.theme-option:hover {
    border-color: var(--primary-light);
}

.theme-option.active {
    border-color: var(--primary-color);
    background: rgba(99, 102, 241, 0.05);
}

.theme-preview {
    width: 100%;
    height: 5rem;
    border-radius: var(--radius-md);
    overflow: hidden;
    position: relative;
}

.theme-preview.dark {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
}

.theme-preview.light {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
}

.preview-header {
    height: 1.5rem;
    background: rgba(0, 0, 0, 0.1);
}

.preview-body {
    height: calc(100% - 1.5rem);
    padding: 0.5rem;
}

.theme-preview.dark .preview-body::before,
.theme-preview.light .preview-body::before {
    content: '';
    display: block;
    width: 60%;
    height: 0.5rem;
    background: rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-sm);
    margin-bottom: 0.25rem;
}

.theme-preview.light .preview-body::before {
    background: rgba(0, 0, 0, 0.1);
}

.theme-option span {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
}

/* Формы в профиле */
.profile-card h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.profile-card h3 i {
    color: var(--primary-color);
}

#edit-profile-form,
#change-password-form,
#change-username-form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
}

.danger-zone {
    border-color: rgba(239, 68, 68, 0.3);
    background: rgba(239, 68, 68, 0.05);
}

.danger-zone h3 {
    color: var(--danger-color);
}

.danger-zone p {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
}

.danger-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

/* Уведомления */
.notification {
    position: fixed;
    top: 1.5rem;
    right: 1.5rem;
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    transform: translateX(120%);
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    border-left: 4px solid var(--primary-color);
    max-width: 400px;
}

.notification.show {
    transform: translateX(0);
}

.notification.success {
    border-left-color: var(--success-color);
}

.notification.error {
    border-left-color: var(--danger-color);
}

.notification.info {
    border-left-color: var(--info-color);
}

.notification i {
    font-size: 1.25rem;
}

.notification.success i {
    color: var(--success-color);
}

.notification.error i {
    color: var(--danger-color);
}

.notification.info i {
    color: var(--info-color);
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: var(--text-primary);
}

.notification-message {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.notification-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.25rem;
    font-size: 1rem;
    transition: var(--transition);
}

.notification-close:hover {
    color: var(--text-primary);
}

/* Мобильное меню */
.mobile-menu {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-card);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-around;
    padding: 0.75rem;
    z-index: 1000;
    display: none;
}

.mobile-menu-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.75rem;
    padding: 0.5rem;
    border-radius: var(--radius-md);
    transition: var(--transition);
}

.mobile-menu-item.active,
.mobile-menu-item:hover {
    color: var(--primary-color);
    background: var(--bg-input);
}

.mobile-menu-item i {
    font-size: 1.25rem;
}

/* Скроллбар */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--bg-input);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--text-muted);
}

/* Адаптивность */
@media (max-width: 1024px) {
    .profile-content {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .profile-left,
    .profile-right {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .chat-app {
        flex-direction: column;
    }

    .sidebar {
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
    }

    .contacts-container {
        max-height: 300px;
    }

    .profile-content {
        padding: 0.5rem;
    }

    .profile-nav {
        padding: 0.5rem;
    }

    .notification {
        left: 1rem;
        right: 1rem;
        max-width: none;
    }

    .mobile-menu {
        display: flex;
    }

    .call-modal-content {
        width: 95%;
        margin: 1rem;
    }

    .video-container {
        height: 200px;
    }

    #local-video {
        width: 80px;
        height: 60px;
    }
}

@media (max-width: 480px) {
    .auth-card {
        padding: 1.5rem;
    }

    .logo {
        font-size: 1.5rem;
    }

    .logo i {
        font-size: 1.75rem;
    }

    .auth-header h1 {
        font-size: 1.5rem;
    }

    .theme-selector {
        grid-template-columns: 1fr;
    }

    .message {
        max-width: 85%;
    }

    .call-controls {
        gap: 0.5rem;
    }

    .call-controls .btn-icon {
        width: 3rem;
        height: 3rem;
    }
}

/* Загрузчик */
.loader {
    display: inline-block;
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid var(--border-color);
    border-radius: 50%;
    border-top-color: var(--primary-color);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Индикатор загрузки */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.loading-spinner {
    width: 3rem;
    height: 3rem;
    border: 3px solid var(--border-color);
    border-radius: 50%;
    border-top-color: var(--primary-color);
    animation: spin 1s linear infinite;
}

/* Анимации */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.pulse {
    animation: pulse 2s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

.bounce {
    animation: bounce 2s infinite;
}
/* Индикатор загрузки сообщения */
.btn-send:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Улучшенные стили для медиа */
.message-media {
    position: relative;
    max-width: 300px;
    margin: 0.5rem 0;
}

.message-media img {
    max-width: 100%;
    max-height: 300px;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: transform 0.2s ease;
    display: block;
}

.message-media video {
    max-width: 100%;
    max-height: 300px;
    border-radius: var(--radius-md);
    background: #000;
    cursor: pointer;
}

.message-media img:hover {
    transform: scale(1.02);
}

.media-caption {
    margin-top: 0.5rem;
    padding: 0.5rem 0;
    color: inherit;
    font-size: 0.9375rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.message.outgoing .media-caption {
    border-top-color: rgba(255, 255, 255, 0.2);
}

/* Превью вложения */
.attachment-preview {
    margin-top: 0.5rem;
    padding: 1rem;
    background: var(--bg-input);
    border-radius: var(--radius-md);
    border: 2px dashed var(--border-color);
    display: none;
}

.preview-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

.preview-content {
    flex: 1;
    display: flex;
    gap: 1rem;
    align-items: center;
}

.preview-image img,
.preview-video video {
    max-width: 150px;
    max-height: 150px;
    border-radius: var(--radius-md);
    object-fit: cover;
}

.preview-video video {
    background: #000;
}

.preview-info {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.btn-remove-attachment {
    background: var(--danger-color);
    color: white;
}

.btn-remove-attachment:hover {
    background: #dc2626;
}

/* Сообщения о загрузке */
.upload-progress {
    width: 100%;
    height: 4px;
    background: var(--border-color);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.upload-progress-bar {
    height: 100%;
    background: var(--primary-color);
    transition: width 0.3s ease;
}

/* Анимации */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message {
    animation: fadeIn 0.3s ease;
}

/* Адаптивность для медиа */
@media (max-width: 768px) {
    .message-media {
        max-width: 250px;
    }

    .message-media img,
    .message-media video {
        max-height: 250px;
    }
}

@media (max-width: 480px) {
    .message-media {
        max-width: 200px;
    }

    .message-media img,
    .message-media video {
        max-height: 200px;
    }

    .preview-image img,
    .preview-video video {
        max-width: 100px;
        max-height: 100px;
    }
}
/* Контекстное меню для сообщений */
.context-menu {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-color);
    min-width: 180px;
    z-index: 10000;
    overflow: hidden;
}

.context-menu-content {
    padding: 0.25rem 0;
}

.context-menu-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-primary);
    font-size: 0.875rem;
}

.context-menu-item:hover {
    background: var(--bg-input);
}

.context-menu-item i {
    width: 1rem;
    text-align: center;
    color: var(--text-secondary);
}

/* Просмотр профиля в поиске */
.search-result {
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}

.search-result:hover {
    background: var(--bg-hover);
}

.user-status-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border-radius: var(--radius-full);
    font-weight: 500;
}

.user-status-badge.online {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success-color);
}

.user-status-badge.offline {
    background: rgba(148, 163, 184, 0.2);
    color: var(--text-secondary);
}

/* Улучшенные кнопки действий */
.message-bubble {
    position: relative;
}

.message-bubble:hover::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.03);
    pointer-events: none;
    border-radius: var(--radius-lg);
}

.message.outgoing .message-bubble:hover::after {
    background: rgba(255, 255, 255, 0.05);
}

/* Анимация для сообщений */
@keyframes messageAppear {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message {
    animation: messageAppear 0.3s ease;
}

/* Улучшенный скроллбар */
.messages-container::-webkit-scrollbar {
    width: 8px;
}

.messages-container::-webkit-scrollbar-track {
    background: transparent;
}

.messages-container::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 4px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: var(--text-muted);
}

/* Адаптивность для контекстного меню */
@media (max-width: 768px) {
    .context-menu {
        min-width: 160px;
        font-size: 0.8125rem;
    }

    .context-menu-item {
        padding: 0.625rem 0.875rem;
    }
}

/* Эффекты для интерактивных элементов */
.btn-icon:active {
    transform: scale(0.95);
}

.message-avatar {
    cursor: pointer;
    transition: transform 0.2s ease;
}

.message-avatar:hover {
    transform: scale(1.05);
}

.contact-item.active .contact-avatar {
    border: 2px solid var(--primary-color);
}

/* Индикатор нового сообщения */
.new-message-indicator {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 12px;
    height: 12px;
    background: var(--danger-color);
    border-radius: 50%;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.7;
        transform: scale(1.1);
    }
}

/* Улучшенный поиск */
.search-box {
    position: relative;
}

.search-box:focus-within {
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.search-results {
    max-height: 400px;
    overflow-y: auto;
}

.search-results::-webkit-scrollbar {
    width: 6px;
}

.search-results::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 3px;
}

/* Индикатор загрузки для чата */
.chat-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    color: var(--text-secondary);
}

.chat-loading .loader {
    width: 2rem;
    height: 2rem;
    border-width: 3px;
    margin-bottom: 1rem;
}
/* Стили для списка пользователей */
.users-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 500px;
    overflow-y: auto;
}

.user-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-input);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    transition: var(--transition);
}

.user-item:hover {
    border-color: var(--primary-color);
    background: var(--bg-hover);
}

.user-item .user-avatar {
    width: 3rem;
    height: 3rem;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: white;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
}

.user-item .user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-info {
    flex: 1;
    min-width: 0;
}

.user-name-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.25rem;
}

.user-name-row h4 {
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--text-primary);
}

.user-username {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.user-description {
    font-size: 0.8125rem;
    color: var(--text-primary);
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.user-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
}

.modal-content {
    max-width: 600px;
    width: 90%;
}
/* Контекстное меню для сообщений */
.context-menu {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-color);
    min-width: 180px;
    z-index: 10000;
    overflow: hidden;
    animation: fadeIn 0.15s ease;
}

.context-menu-content {
    padding: 0.25rem 0;
}

.context-menu-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-primary);
    font-size: 0.875rem;
    user-select: none;
}

.context-menu-item:hover {
    background: var(--bg-input);
}

.context-menu-item i {
    width: 1rem;
    text-align: center;
    color: var(--text-secondary);
}

/* Поиск */
.search-result {
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: var(--transition);
}

.search-result:hover {
    background: var(--bg-hover);
}

.no-results {
    padding: 1.5rem;
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.user-status-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border-radius: var(--radius-full);
    font-weight: 500;
    white-space: nowrap;
}

.user-status-badge.online {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success-color);
}

.user-status-badge.offline {
    background: rgba(148, 163, 184, 0.2);
    color: var(--text-secondary);
}

/* Модальные окна */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
    animation: fadeIn 0.2s ease;
}

.modal-content {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-lg);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.modal-body {
    padding: 1.5rem;
    flex: 1;
    overflow-y: auto;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

/* Forward dialog specific */
.forward-message-preview {
    background: var(--bg-input);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 1rem;
}

.message-preview {
    font-size: 0.875rem;
}

.message-preview strong {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.message-preview p {
    color: var(--text-secondary);
    line-height: 1.4;
}

.search-recipient {
    position: relative;
}

.search-recipient input {
    width: 100%;
    padding: 0.875rem 1rem;
    background: var(--bg-input);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.9375rem;
    transition: var(--transition);
}

.search-recipient input:focus {
    outline: none;
    border-color: var(--primary-color);
    background: var(--bg-card);
}

/* Анимации */
@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.message {
    animation: fadeIn 0.3s ease;
}

/* Индикатор загрузки */
.fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

/* Превью ответа */
.reply-preview {
    background: var(--bg-input);
    border-radius: var(--radius-md);
    margin: 0 2rem 0.5rem;
    border-left: 3px solid var(--primary-color);
    position: relative;
}

.reply-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

.reply-preview-header span {
    font-size: 0.75rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.reply-preview-content {
    padding: 0.75rem 1rem;
}

.reply-preview-content strong {
    display: block;
    margin-bottom: 0.25rem;
    color: var(--primary-color);
    font-size: 0.875rem;
}

.reply-preview-content p {
    font-size: 0.875rem;
    color: var(--text-primary);
    line-height: 1.4;
    margin: 0;
}

/* Forward label in messages */
.forward-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.forward-label i {
    font-size: 0.625rem;
}

/* Edit label in messages */
.edit-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.edit-label i {
    font-size: 0.625rem;
}

/* Редактирование сообщения */
.edit-message-container {
    background: var(--bg-card);
    border-top: 1px solid var(--border-color);
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    animation: slideInUp 0.3s ease;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.edit-message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.edit-message-header span {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

#edit-message-form {
    display: flex;
    align-items: center;
    gap: 1rem;
}

#edit-message-input {
    flex: 1;
    padding: 0.875rem 1.25rem;
    background: var(--bg-input);
    border: 2px solid var(--primary-color);
    border-radius: var(--radius-full);
    color: var(--text-primary);
    font-size: 0.9375rem;
    transition: var(--transition);
}

#edit-message-input:focus {
    outline: none;
    background: var(--bg-card);
}

/* Улучшенный скроллбар */
.search-results::-webkit-scrollbar,
.messages-container::-webkit-scrollbar,
.modal-body::-webkit-scrollbar {
    width: 6px;
}

.search-results::-webkit-scrollbar-track,
.messages-container::-webkit-scrollbar-track,
.modal-body::-webkit-scrollbar-track {
    background: transparent;
}

.search-results::-webkit-scrollbar-thumb,
.messages-container::-webkit-scrollbar-thumb,
.modal-body::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 3px;
}

.search-results::-webkit-scrollbar-thumb:hover,
.messages-container::-webkit-scrollbar-thumb:hover,
.modal-body::-webkit-scrollbar-thumb:hover {
    background: var(--text-muted);
}

/* Адаптивность */
@media (max-width: 768px) {
    .context-menu {
        min-width: 160px;
        font-size: 0.8125rem;
    }

    .context-menu-item {
        padding: 0.625rem 0.875rem;
    }

    .reply-preview {
        margin: 0 1rem 0.5rem;
    }

    .modal-content {
        width: 95%;
        margin: 1rem;
    }
}
/* Стили для звонков */
.call-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.95);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.call-modal-content {
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    width: 90%;
    max-width: 500px;
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    animation: modalAppear 0.3s ease;
}

@keyframes modalAppear {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

.call-modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    text-align: center;
}

.call-modal-header h3 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
}

#call-timer {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-left: 0.5rem;
}

.call-modal-body {
    padding: 2rem 1.5rem;
    text-align: center;
}

.calling-animation {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
}

.calling-dots {
    display: flex;
    gap: 0.5rem;
}

.calling-dots .dot {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
    background: var(--primary-color);
    animation: dotPulse 1.4s ease-in-out infinite;
}

.calling-dots .dot:nth-child(1) { animation-delay: -0.32s; }
.calling-dots .dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes dotPulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
}

.incoming-call {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
}

.caller-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.caller-avatar {
    width: 5rem;
    height: 5rem;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: 600;
    color: white;
}

.caller-details {
    text-align: center;
}

.caller-details h4 {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
}

.caller-details p {
    color: var(--text-secondary);
}

.active-call {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.active-call p {
    font-size: 1.125rem;
    color: var(--text-primary);
}

.video-placeholder, .audio-placeholder {
    width: 200px;
    height: 200px;
    border-radius: var(--radius-xl);
    background: var(--bg-input);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin: 1rem auto;
}

.video-placeholder i, .audio-placeholder i {
    font-size: 3rem;
    color: var(--primary-color);
}

.video-placeholder p, .audio-placeholder p {
    color: var(--text-secondary);
}

.call-modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: center;
    gap: 1rem;
}

@media (max-width: 768px) {
    .call-modal-content {
        width: 95%;
        margin: 1rem;
    }
}
/* Стили для звонков */
.call-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.95);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.call-modal-content {
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    width: 90%;
    max-width: 500px;
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    animation: modalAppear 0.3s ease;
}

@keyframes modalAppear {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.call-header {
    padding: 1.5rem;
    text-align: center;
    border-bottom: 1px solid var(--border-color);
}

.call-header h3 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.call-timer {
    font-size: 1.25rem;
    color: var(--primary-color);
    font-weight: 500;
    font-family: monospace;
}

.call-body {
    padding: 2rem;
    text-align: center;
}

.video-container {
    position: relative;
    width: 100%;
    height: 300px;
    background: var(--bg-darker);
    border-radius: var(--radius-lg);
    overflow: hidden;
    margin-bottom: 1.5rem;
}

#remote-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: #000;
}

#local-video {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    width: 120px;
    height: 90px;
    border-radius: var(--radius-md);
    object-fit: cover;
    border: 2px solid var(--primary-color);
    background: #000;
}

.call-info {
    margin-bottom: 1.5rem;
}

#call-status {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

#call-with {
    font-size: 1rem;
    color: var(--text-secondary);
}

.call-controls {
    display: flex;
    justify-content: center;
    gap: 1rem;
    padding: 1.5rem;
    background: var(--bg-darker);
    border-top: 1px solid var(--border-color);
}

.call-control-btn {
    width: 3.5rem;
    height: 3.5rem;
    border-radius: 50%;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    transition: var(--transition);
}

.call-control-btn:not(.end-call-btn):not(.reject-call-btn) {
    background: var(--bg-input);
    color: var(--text-primary);
}

.call-control-btn:not(.end-call-btn):not(.reject-call-btn):hover {
    background: var(--bg-hover);
    transform: scale(1.05);
}

.end-call-btn, .reject-call-btn {
    background: var(--danger-color);
    color: white;
}

.end-call-btn:hover, .reject-call-btn:hover {
    background: #dc2626;
    transform: scale(1.05);
}

.call-control-btn i {
    font-size: 1.25rem;
}

/* Анимация звонка */
@keyframes pulse-ring {
    0% {
        transform: scale(0.8);
        opacity: 0.8;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.4;
    }
    100% {
        transform: scale(0.8);
        opacity: 0.8;
    }
}

.call-ringing .call-control-btn:first-child {
    animation: pulse-ring 2s infinite;
}

/* Адаптивность для звонков */
@media (max-width: 768px) {
    .call-modal-content {
        width: 95%;
        max-width: none;
    }

    .video-container {
        height: 250px;
    }

    #local-video {
        width: 100px;
        height: 75px;
    }

    .call-controls {
        gap: 0.75rem;
        padding: 1rem;
    }

    .call-control-btn {
        width: 3rem;
        height: 3rem;
        font-size: 1rem;
    }
}

@media (max-width: 480px) {
    .video-container {
        height: 200px;
    }

    #local-video {
        width: 80px;
        height: 60px;
        bottom: 0.5rem;
        right: 0.5rem;
    }

    .call-controls {
        gap: 0.5rem;
    }

    .call-control-btn {
        width: 2.75rem;
        height: 2.75rem;
    }
}
/* Добавить в существующий style.css */

/* Стили для уведомлений */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1rem 1.5rem;
    box-shadow: var(--shadow-lg);
    z-index: 1003;
    animation: slideIn 0.3s ease;
    max-width: 350px;
}

.notification-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.notification i {
    font-size: 1.25rem;
}

.notification-success i { color: var(--success-color); }
.notification-error i { color: var(--danger-color); }
.notification-warning i { color: var(--warning-color); }
.notification-info i { color: var(--info-color); }

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Диалог подтверждения */
.confirm-dialog {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1004;
    display: flex;
    align-items: center;
    justify-content: center;
}

.confirm-dialog-content {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 2rem;
    max-width: 400px;
    width: 90%;
}

.confirm-message {
    margin-bottom: 1.5rem;
    font-size: 1.125rem;
    line-height: 1.5;
}

.confirm-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

/* Анимации для сообщений */
.message {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Адаптивность для мобильных */
@media (max-width: 768px) {
    .call-modal-content {
        width: 95%;
        height: 95%;
    }

    .video-container {
        height: 200px;
    }

    #local-video {
        width: 80px;
        height: 60px;
    }

    .call-control-btn {
        width: 50px;
        height: 50px;
        font-size: 1rem;
    }

    .stickers-container {
        grid-template-columns: repeat(3, 1fr);
    }

    .sticker-item {
        font-size: 1.5rem;
    }
}

/* Темная тема */
@media (prefers-color-scheme: dark) {
    .notification {
        background: #1a1a1a;
        border-color: #333;
    }

    .confirm-dialog-content {
        background: #1a1a1a;
    }
}
/* Добавьте эти стили в конец style.css */

/* Стикеры */
.stickers-container {
    position: absolute;
    bottom: 100%;
    left: 0;
    right: 0;
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    max-height: 300px;
    overflow: hidden;
    display: none;
}

.stickers-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.stickers-header h4 {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sticker-categories {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem;
    border-bottom: 1px solid var(--border-color);
    overflow-x: auto;
}

.sticker-category-btn {
    padding: 0.5rem 1rem;
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    transition: var(--transition);
}

.sticker-category-btn:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.sticker-category-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.stickers-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.5rem;
    padding: 1rem;
    max-height: 200px;
    overflow-y: auto;
}

.sticker-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 0.75rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition);
}

.sticker-item:hover {
    background: var(--bg-input);
}

.sticker-emoji {
    font-size: 2rem;
    line-height: 1;
}

.sticker-text {
    font-size: 0.625rem;
    color: var(--text-secondary);
    text-align: center;
    line-height: 1.2;
}

/* Стикер в сообщении */
.message-sticker {
    padding: 0.5rem;
}

.sticker-emoji-large {
    font-size: 3rem;
    line-height: 1;
}

/* Контекстное меню */
.context-menu {
    position: fixed;
    background: var(--bg-card);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-color);
    min-width: 180px;
    z-index: 10000;
    overflow: hidden;
    animation: fadeIn 0.15s ease;
}

.context-menu-content {
    padding: 0.25rem 0;
}

.context-menu-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-primary);
    font-size: 0.875rem;
    user-select: none;
}

.context-menu-item:hover {
    background: var(--bg-input);
}

.context-menu-item i {
    width: 1rem;
    text-align: center;
    color: var(--text-secondary);
}

/* Превью ответа */
.reply-preview {
    background: var(--bg-input);
    border-radius: var(--radius-md);
    margin-bottom: 0.75rem;
    border-left: 3px solid var(--primary-color);
    position: relative;
}

.reply-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

.reply-preview-header span {
    font-size: 0.75rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.reply-preview-content {
    padding: 0.75rem 1rem;
}

.reply-preview-content strong {
    display: block;
    margin-bottom: 0.25rem;
    color: var(--primary-color);
    font-size: 0.875rem;
}

.reply-preview-content p {
    font-size: 0.875rem;
    color: var(--text-primary);
    line-height: 1.4;
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

/* Пересылка сообщения */
.forward-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.forward-label i {
    font-size: 0.625rem;
}

/* Редактирование сообщения */
.edit-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.edit-label i {
    font-size: 0.625rem;
}

/* Модальное окно для пересылки */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
    animation: fadeIn 0.2s ease;
}

.modal-content {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-lg);
    animation: slideIn 0.3s ease;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.modal-body {
    padding: 1.5rem;
    flex: 1;
    overflow-y: auto;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

.forward-message-preview {
    background: var(--bg-input);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 1rem;
}

.message-preview {
    font-size: 0.875rem;
}

.message-preview strong {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.message-preview p {
    color: var(--text-secondary);
    line-height: 1.4;
}

.search-recipient {
    position: relative;
    margin-bottom: 1rem;
}

.search-recipient input {
    width: 100%;
    padding: 0.875rem 1rem;
    background: var(--bg-input);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.9375rem;
    transition: var(--transition);
}

.search-recipient input:focus {
    outline: none;
    border-color: var(--primary-color);
    background: var(--bg-card);
}

.users-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 300px;
    overflow-y: auto;
}

.user-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: var(--bg-input);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: var(--transition);
}

.user-item:hover {
    border-color: var(--primary-color);
    background: var(--bg-hover);
}

.user-item .user-avatar {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: white;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
}

.user-item .user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-item .user-info {
    flex: 1;
    min-width: 0;
}

.user-item .user-name-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.25rem;
}

.user-item .user-name-row h4 {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
}

.user-item .user-username {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

/* Редактирование сообщения */
.edit-message-container {
    background: var(--bg-card);
    border-top: 1px solid var(--border-color);
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    animation: slideInUp 0.3s ease;
}

.edit-message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.edit-message-header span {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

#edit-message-form {
    display: flex;
    align-items: center;
    gap: 1rem;
}

#edit-message-input {
    flex: 1;
    padding: 0.875rem 1.25rem;
    background: var(--bg-input);
    border: 2px solid var(--primary-color);
    border-radius: var(--radius-full);
    color: var(--text-primary);
    font-size: 0.9375rem;
    transition: var(--transition);
}

#edit-message-input:focus {
    outline: none;
    background: var(--bg-card);
}

/* Анимации */
@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Адаптивность */
@media (max-width: 768px) {
    .stickers-grid {
        grid-template-columns: repeat(4, 1fr);
    }

    .context-menu {
        min-width: 160px;
        font-size: 0.8125rem;
    }

    .context-menu-item {
        padding: 0.625rem 0.875rem;
    }

    .modal-content {
        width: 95%;
        margin: 1rem;
    }
}

@media (max-width: 480px) {
    .stickers-grid {
        grid-template-columns: repeat(3, 1fr);
    }

    .sticker-emoji {
        font-size: 1.75rem;
    }
}
/* Добавьте в style.css */
.pinned-messages-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-height: 400px;
    overflow-y: auto;
}

.pinned-message-item {
    background: var(--bg-input);
    border-radius: var(--radius-md);
    padding: 1rem;
    border-left: 3px solid var(--primary-color);
}

.pinned-message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
}

.pinned-message-header span:first-child {
    color: var(--text-primary);
    font-weight: 500;
}

.pinned-time {
    color: var(--text-secondary);
    font-size: 0.75rem;
}

.pinned-message-content {
    margin-bottom: 1rem;
}

.pinned-message-content p {
    color: var(--text-primary);
    font-size: 0.875rem;
    line-height: 1.4;
    margin: 0;
}

.pinned-message-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
}
/* Стили для зашифрованных сообщений */
.encryption-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    font-size: 10px;
    color: var(--success-color);
}

.btn-decrypt {
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    justify-content: center;
}

.btn-decrypt:hover {
    background: var(--primary-dark);
}

.encrypted-content {
    padding: 1rem;
    background: rgba(99, 102, 241, 0.1);
    border-radius: var(--radius-md);
    border: 1px dashed var(--primary-color);
    text-align: center;
}

/* Стили для документов */
.message-document {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-input);
    border-radius: var(--radius-md);
    margin: 0.5rem 0;
}

.document-icon {
    font-size: 2rem;
    color: var(--primary-color);
}

.document-info {
    flex: 1;
}

.document-name {
    font-weight: 500;
    margin-bottom: 0.25rem;
    word-break: break-word;
}

.document-size {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.btn-download {
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
}

.btn-download:hover {
    background: var(--primary-dark);
}

.document-caption {
    margin-top: 0.5rem;
    padding: 0.5rem 0;
    color: inherit;
    font-size: 0.9375rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.message.outgoing .document-caption {
    border-top-color: rgba(255, 255, 255, 0.2);
}

/* Индикатор безопасности */
.security-indicator {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
    z-index: 1000;
    box-shadow: var(--shadow-md);
}

.security-indicator.secure {
    border-color: var(--success-color);
    color: var(--success-color);
}

.security-indicator.insecure {
    border-color: var(--danger-color);
    color: var(--danger-color);
}

/* Документ в превью */
.document-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
    background: var(--bg-input);
    border-radius: var(--radius-md);
}

/* Примечание о безопасности в чате */
.security-note {
    margin-top: 1rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    justify-content: center;
}

/* Улучшенные кнопки для файлов */
#attach-file {
    display: flex !important;
}

/* Анимация для зашифрованных сообщений */
@keyframes pulse-encrypted {
    0%, 100% {
        opacity: 0.8;
    }
    50% {
        opacity: 1;
    }
}

.encrypted-content {
    animation: pulse-encrypted 2s infinite;
}

/* Стили для разных типов файлов */
.file-icon-pdf { color: #FF6B6B; }
.file-icon-doc { color: #4ECDC4; }
.file-icon-xls { color: #45B7D1; }
.file-icon-ppt { color: #96CEB4; }
.file-icon-zip { color: #FFEAA7; }
.file-icon-audio { color: #DDA0DD; }
.file-icon-video { color: #98D8C8; }

/* Адаптивность для документов */
@media (max-width: 768px) {
    .message-document {
        padding: 0.75rem;
        gap: 0.75rem;
    }

    .document-icon {
        font-size: 1.5rem;
    }

    .security-indicator {
        bottom: 0.5rem;
        right: 0.5rem;
        left: 0.5rem;
        font-size: 0.75rem;
    }
}

@media (max-width: 480px) {
    .message-document {
        flex-direction: column;
        text-align: center;
    }

    .document-info {
        text-align: center;
    }

    .btn-decrypt {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
    }
}/* Стили для зашифрованных сообщений */
.encryption-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    font-size: 10px;
    color: var(--success-color);
}

.btn-decrypt {
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    justify-content: center;
}

.btn-decrypt:hover {
    background: var(--primary-dark);
}

.encrypted-content {
    padding: 1rem;
    background: rgba(99, 102, 241, 0.1);
    border-radius: var(--radius-md);
    border: 1px dashed var(--primary-color);
    text-align: center;
}

/* Стили для документов */
.message-document {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-input);
    border-radius: var(--radius-md);
    margin: 0.5rem 0;
}

.document-icon {
    font-size: 2rem;
    color: var(--primary-color);
}

.document-info {
    flex: 1;
}

.document-name {
    font-weight: 500;
    margin-bottom: 0.25rem;
    word-break: break-word;
}

.document-size {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.btn-download {
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
}

.btn-download:hover {
    background: var(--primary-dark);
}

.document-caption {
    margin-top: 0.5rem;
    padding: 0.5rem 0;
    color: inherit;
    font-size: 0.9375rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.message.outgoing .document-caption {
    border-top-color: rgba(255, 255, 255, 0.2);
}

/* Индикатор безопасности */
.security-indicator {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
    z-index: 1000;
    box-shadow: var(--shadow-md);
}

.security-indicator.secure {
    border-color: var(--success-color);
    color: var(--success-color);
}

.security-indicator.insecure {
    border-color: var(--danger-color);
    color: var(--danger-color);
}

/* Документ в превью */
.document-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
    background: var(--bg-input);
    border-radius: var(--radius-md);
}

/* Примечание о безопасности в чате */
.security-note {
    margin-top: 1rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    justify-content: center;
}

/* Улучшенные кнопки для файлов */
#attach-file {
    display: flex !important;
}

/* Анимация для зашифрованных сообщений */
@keyframes pulse-encrypted {
    0%, 100% {
        opacity: 0.8;
    }
    50% {
        opacity: 1;
    }
}

.encrypted-content {
    animation: pulse-encrypted 2s infinite;
}

/* Стили для разных типов файлов */
.file-icon-pdf { color: #FF6B6B; }
.file-icon-doc { color: #4ECDC4; }
.file-icon-xls { color: #45B7D1; }
.file-icon-ppt { color: #96CEB4; }
.file-icon-zip { color: #FFEAA7; }
.file-icon-audio { color: #DDA0DD; }
.file-icon-video { color: #98D8C8; }

/* Адаптивность для документов */
@media (max-width: 768px) {
    .message-document {
        padding: 0.75rem;
        gap: 0.75rem;
    }

    .document-icon {
        font-size: 1.5rem;
    }

    .security-indicator {
        bottom: 0.5rem;
        right: 0.5rem;
        left: 0.5rem;
        font-size: 0.75rem;
    }
}

@media (max-width: 480px) {
    .message-document {
        flex-direction: column;
        text-align: center;
    }

    .document-info {
        text-align: center;
    }

    .btn-decrypt {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
    }
}
/* Стили для файлов */
.preview-file {
    display: none;
}

.file-preview {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-input);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
}

.file-icon {
    font-size: 2.5rem;
    flex-shrink: 0;
}

.file-info {
    flex: 1;
    min-width: 0;
}

.file-name {
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
    word-break: break-word;
}

.file-size {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

/* Стили для сообщений с файлами */
.message-file {
    margin: 0.5rem 0;
}

.file-container {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-input);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: inherit;
    transition: var(--transition);
    border: 1px solid var(--border-color);
}

.message.incoming .file-container {
    background: rgba(255, 255, 255, 0.05);
}

.message.outgoing .file-container {
    background: rgba(255, 255, 255, 0.1);
}

.file-container:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.file-download {
    color: var(--primary-color);
    font-size: 1.25rem;
}

.file-caption {
    margin-top: 0.5rem;
    padding: 0.5rem 0;
    color: inherit;
    font-size: 0.9375rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

/* Стили для аудио сообщений */
.message-file audio {
    width: 100%;
    margin-top: 0.5rem;
    border-radius: var(--radius-md);
}

/* Панель стикеров */
.stickers-panel {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 320px;
    max-height: 400px;
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    display: none;
    flex-direction: column;
    overflow: hidden;
}

.stickers-panel.show {
    display: flex;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.stickers-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.stickers-header h4 {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sticker-categories {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem;
    border-bottom: 1px solid var(--border-color);
    overflow-x: auto;
    flex-shrink: 0;
}

.sticker-category-btn {
    padding: 0.5rem 1rem;
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    transition: var(--transition);
    border: none;
    outline: none;
}

.sticker-category-btn:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.sticker-category-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.stickers-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
    padding: 1rem;
    max-height: 300px;
    overflow-y: auto;
}

.sticker-item {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition);
    aspect-ratio: 1;
}

.sticker-item:hover {
    background: var(--bg-input);
}

.sticker-emoji {
    font-size: 2rem;
    line-height: 1;
}

/* Стикер в сообщении */
.message-sticker {
    padding: 0.5rem;
}

.message-sticker .sticker-emoji {
    font-size: 3rem;
    line-height: 1;
}

/* Уведомления */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1rem 1.5rem;
    box-shadow: var(--shadow-lg);
    z-index: 1003;
    animation: slideIn 0.3s ease;
    max-width: 350px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.notification i {
    font-size: 1.25rem;
}

.notification-success i { color: var(--success-color); }
.notification-error i { color: var(--danger-color); }
.notification-info i { color: var(--info-color); }

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Адаптивность */
@media (max-width: 768px) {
    .stickers-panel {
        width: calc(100% - 40px);
        right: 20px;
        left: 20px;
        bottom: 100px;
    }

    .stickers-grid {
        grid-template-columns: repeat(3, 1fr);
    }

    .sticker-emoji {
        font-size: 1.75rem;
    }

    .message-sticker .sticker-emoji {
        font-size: 2.5rem;
    }

    .notification {
        left: 20px;
        right: 20px;
        max-width: none;
    }
}

@media (max-width: 480px) {
    .stickers-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .sticker-item {
        padding: 0.5rem;
    }
}
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация
    const socket = io();
    const currentUser = document.getElementById('current-user').value;
    const currentUserName = document.getElementById('current-user-name').value;
    const currentUserColor = document.getElementById('current-user-color').value;
    const isAdmin = document.getElementById('is-admin') ? document.getElementById('is-admin').value === 'true' : false;

    // Переменные состояния
    let currentRecipient = null;
    let currentRecipientName = '';
    let currentRecipientColor = '';
    let typingTimeout = null;
    let currentAttachment = null;
    let allMessages = [];
    let isWindowFocused = true;
    let unreadMessages = {};

    // Переменные для звонков
    let activeCall = null;
    let peerConnection = null;
    let localStream = null;
    let remoteStream = null;
    let callTimer = null;
    let callStartTime = null;
    let isMuted = false;
    let isVideoMuted = false;

    // Элементы DOM
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const messagesContainer = document.getElementById('messages-container');
    const messageInput = document.getElementById('message-input');
    const typingIndicator = document.getElementById('typing-indicator');
    const typingText = document.getElementById('typing-text');
    const messageInputContainer = document.getElementById('message-input-container');
    const chatHeader = document.getElementById('chat-header');
    const onlineCount = document.getElementById('online-count');
    const contactsList = document.getElementById('contacts-list');
    const emptyContacts = document.getElementById('empty-contacts');
    const sendMessageBtn = document.getElementById('send-message-btn');

    // Элементы для вложений
    const attachPhotoBtn = document.getElementById('attach-photo');
    const attachVideoBtn = document.getElementById('attach-video');
    const attachFileBtn = document.getElementById('attach-file');
    const attachStickerBtn = document.getElementById('stickers-toggle');
    const photoInput = document.getElementById('photo-input');
    const videoInput = document.getElementById('video-input');
    const fileInput = document.getElementById('file-input');
    const attachmentPreview = document.getElementById('attachment-preview');
    const previewImage = document.getElementById('preview-image');
    const previewVideo = document.getElementById('preview-video');
    const previewFile = document.getElementById('preview-file');
    const previewInfo = document.getElementById('preview-info');
    const removeAttachmentBtn = document.getElementById('remove-attachment');

    // Элементы для звонков
    const callModal = document.getElementById('call-modal');
    const callTitle = document.getElementById('call-title');
    const callTimerElement = document.getElementById('call-timer');
    const callStatus = document.getElementById('call-status');
    const callWith = document.getElementById('call-with');
    const acceptCallBtn = document.getElementById('accept-call-btn');
    const rejectCallBtn = document.getElementById('reject-call-btn');
    const endCallBtn = document.getElementById('end-call-btn');
    const muteAudioBtn = document.getElementById('mute-audio-btn');
    const muteVideoBtn = document.getElementById('mute-video-btn');
    const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');

    // ============ ОСНОВНЫЕ ФУНКЦИИ ============

    // Инициализация WebSocket
    function initWebSocket() {
        socket.on('connect', () => {
            console.log('✓ Подключен к серверу');
            showNotification('Подключено к серверу', 'success');
            loadContacts();

            // Восстанавливаем последний чат
            restoreLastChat();
        });

        socket.on('disconnect', () => {
            console.log('✗ Отключен от сервера');
            showNotification('Нет подключения к серверу', 'error');
        });

        socket.on('connect_error', (error) => {
            console.error('Ошибка подключения:', error);
            showNotification('Ошибка подключения к серверу', 'error');
        });

        socket.on('user_status', handleUserStatus);
        socket.on('new_message', handleNewMessage);
        socket.on('message_sent', handleMessageSent);
        socket.on('user_typing', handleUserTyping);
        socket.on('message_edited', handleMessageEdited);
        socket.on('message_deleted', handleMessageDeleted);

        // Обработчики для звонков
        socket.on('incoming_call', handleIncomingCall);
        socket.on('call_accepted', handleCallAccepted);
        socket.on('call_rejected', handleCallRejected);
        socket.on('call_ended', handleCallEnded);
        socket.on('call_timeout', handleCallTimeout);
        socket.on('call_error', handleCallError);
        socket.on('webrtc_signal', handleWebRTCSignal);
        socket.on('call_ice_candidate', handleCallIceCandidate);
    }

    // ============ ПОИСК ПОЛЬЗОВАТЕЛЕЙ ============
    function initSearch() {
        if (!searchInput) return;

        searchInput.addEventListener('input', debounce(function(e) {
            const query = e.target.value.trim();
            if (query.length < 1) {
                searchResults.style.display = 'none';
                return;
            }
            searchUsers(query);
        }, 300));

        document.addEventListener('click', function(e) {
            if (searchResults && !searchResults.contains(e.target) && e.target !== searchInput) {
                searchResults.style.display = 'none';
            }
        });
    }

    function searchUsers(query) {
        fetch(`/search_users?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(users => displaySearchResults(users))
            .catch(error => console.error('Search error:', error));
    }

    function displaySearchResults(users) {
        if (!searchResults) return;

        if (!users || users.length === 0) {
            searchResults.innerHTML = '<div class="no-results">Пользователи не найдены</div>';
            searchResults.style.display = 'block';
            return;
        }

        searchResults.innerHTML = '';
        users.forEach(user => {
            const userElement = document.createElement('div');
            userElement.className = 'contact-item search-result';
            userElement.innerHTML = `
                <div class="contact-avatar" style="background: ${user.avatar_color || '#4ECDC4'}">
                    ${user.avatar ? `<img src="${user.avatar}" alt="${user.name}">` : user.name[0].toUpperCase()}
                    <span class="status-indicator ${user.is_online ? 'online' : ''}"></span>
                </div>
                <div class="contact-info">
                    <div class="contact-name-row">
                        <h4>${escapeHtml(user.name)}</h4>
                        <span class="user-status-badge ${user.is_online ? 'online' : 'offline'}">
                            ${user.is_online ? 'онлайн' : 'офлайн'}
                        </span>
                    </div>
                    <p class="contact-preview">
                        @${escapeHtml(user.username)}
                    </p>
                </div>
            `;

            userElement.addEventListener('click', () => {
                openChat(user.username, user.name, user.avatar_color || '#4ECDC4');
                searchInput.value = '';
                searchResults.style.display = 'none';
            });

            searchResults.appendChild(userElement);
        });

        searchResults.style.display = 'block';
    }

    // ============ ЗАГРУЗКА КОНТАКТОВ ============
    function loadContacts() {
        fetch('/api/get_chats')
            .then(response => response.json())
            .then(chats => displayContacts(chats))
            .catch(error => console.error('Error loading contacts:', error));
    }

    function displayContacts(chats) {
        if (!contactsList || !emptyContacts) return;

        if (!chats || chats.length === 0) {
            emptyContacts.style.display = 'block';
            contactsList.innerHTML = '';
            return;
        }

        emptyContacts.style.display = 'none';
        contactsList.innerHTML = '';

        chats.forEach(chat => {
            const contactElement = createContactElement(chat);
            contactsList.appendChild(contactElement);
        });

        updateOnlineCount();
    }

    function createContactElement(chat) {
        const contactItem = document.createElement('div');
        contactItem.className = 'contact-item';
        contactItem.dataset.username = chat.username;
        contactItem.dataset.color = chat.avatar_color || '#4ECDC4';

        let lastMessage = '';
        if (chat.last_message) {
            if (chat.last_message.type === 'image') {
                lastMessage = '📷 Изображение';
            } else if (chat.last_message.type === 'video') {
                lastMessage = '🎬 Видео';
            } else if (chat.last_message.type === 'sticker') {
                lastMessage = '😊 Стикер';
            } else if (chat.last_message.type === 'file') {
                lastMessage = '📎 Файл';
            } else if (chat.last_message.type === 'audio') {
                lastMessage = '🎵 Аудио';
            } else {
                lastMessage = chat.last_message.message || '';
            }
        }

        const time = chat.last_message ? formatTime(chat.last_message.timestamp) : '';

        contactItem.innerHTML = `
            <div class="contact-avatar" style="background: ${chat.avatar_color || '#4ECDC4'}">
                ${chat.avatar ? `<img src="${chat.avatar}" alt="${chat.name}">` : chat.name[0].toUpperCase()}
                <span class="status-indicator ${chat.is_online ? 'online' : ''}" id="status-${chat.username}"></span>
            </div>
            <div class="contact-info">
                <div class="contact-name-row">
                    <h4>${escapeHtml(chat.name)}</h4>
                    <span class="message-time">${time}</span>
                </div>
                <p class="contact-preview">
                    ${escapeHtml(lastMessage.substring(0, 30))}${lastMessage.length > 30 ? '...' : ''}
                </p>
            </div>
        `;

        contactItem.addEventListener('click', () => {
            openChat(chat.username, chat.name, chat.avatar_color || '#4ECDC4');
        });

        return contactItem;
    }

    // ============ ОТКРЫТИЕ И СОХРАНЕНИЕ ЧАТА ============
    function openChat(username, name, color) {
        if (currentRecipient === username) return;

        currentRecipient = username;
        currentRecipientName = name;
        currentRecipientColor = color;

        // Очищаем непрочитанные сообщения для этого чата
        if (unreadMessages[username]) {
            unreadMessages[username] = 0;
            updateUnreadBadge(username);
        }

        // Сохраняем текущий чат
        saveCurrentChat(username);

        // Обновляем интерфейс
        updateChatHeader();

        if (messageInputContainer) {
            messageInputContainer.style.display = 'flex';
        }

        // Загружаем сообщения
        loadMessages();

        // Помечаем активный контакт
        updateActiveContact();

        // Фокус на поле ввода
        setTimeout(() => {
            if (messageInput) messageInput.focus();
        }, 100);
    }

    function saveCurrentChat(username) {
        // Сохраняем в localStorage
        localStorage.setItem('lastChat', JSON.stringify({
            username: username,
            name: currentRecipientName,
            color: currentRecipientColor,
            timestamp: Date.now()
        }));

        // Сохраняем на сервере
        fetch('/api/save_current_chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ chat_with: username })
        }).catch(error => console.error('Error saving chat:', error));
    }

    function restoreLastChat() {
        const lastChat = localStorage.getItem('lastChat');
        if (lastChat) {
            try {
                const chatData = JSON.parse(lastChat);

                // Проверяем возраст данных (не старше 24 часов)
                const chatAge = Date.now() - (chatData.timestamp || 0);
                if (chatAge > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('lastChat');
                    return;
                }

                // Открываем чат
                if (chatData.username) {
                    fetch(`/api/user/${chatData.username}`)
                        .then(response => response.json())
                        .then(user => {
                            if (!user.error) {
                                setTimeout(() => {
                                    openChat(user.username, user.name, user.avatar_color);
                                }, 300);
                            }
                        })
                        .catch(() => {
                            localStorage.removeItem('lastChat');
                        });
                }
            } catch (e) {
                localStorage.removeItem('lastChat');
            }
        }
    }

    // ============ ОБНОВЛЕНИЕ ИНТЕРФЕЙСА ЧАТА ============
    function updateChatHeader() {
        if (!chatHeader) return;

        chatHeader.innerHTML = `
            <div class="user-profile">
                <div class="user-avatar" style="background: ${currentRecipientColor}" id="chat-user-avatar">
                    ${currentRecipientName[0].toUpperCase()}
                    <span class="status-indicator" id="header-status-${currentRecipient}"></span>
                </div>
                <div class="user-info">
                    <h3 id="chat-user-name">${escapeHtml(currentRecipientName)}</h3>
                    <p class="user-status" id="header-status-text-${currentRecipient}">
                        <i class="fas fa-circle"></i> проверка...
                    </p>
                </div>
            </div>
            <div class="chat-actions">
                <button class="btn-icon" id="voice-call-btn" title="Голосовой звонок">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="btn-icon" id="video-call-btn" title="Видеозвонок">
                    <i class="fas fa-video"></i>
                </button>
                <button class="btn-icon" id="block-user-btn" title="Заблокировать">
                    <i class="fas fa-ban"></i>
                </button>
                <button class="btn-icon" id="view-profile-btn" title="Просмотр профиля">
                    <i class="fas fa-user"></i>
                </button>
            </div>
        `;

        // Добавляем обработчики для кнопок в заголовке
        setTimeout(() => {
            const voiceCallBtn = document.getElementById('voice-call-btn');
            const videoCallBtn = document.getElementById('video-call-btn');
            const blockBtn = document.getElementById('block-user-btn');
            const viewProfileBtn = document.getElementById('view-profile-btn');

            if (voiceCallBtn) {
                voiceCallBtn.addEventListener('click', () => startCall('audio'));
            }
            if (videoCallBtn) {
                videoCallBtn.addEventListener('click', () => startCall('video'));
            }
            if (blockBtn) {
                blockBtn.addEventListener('click', toggleBlockUser);
            }
            if (viewProfileBtn) {
                viewProfileBtn.addEventListener('click', () => {
                    window.open(`/profile/${currentRecipient}`, '_blank');
                });
            }
        }, 100);

        // Проверяем онлайн статус
        checkOnlineStatus(currentRecipient);
    }

    function updateActiveContact() {
        document.querySelectorAll('.contact-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.username === currentRecipient) {
                item.classList.add('active');
            }
        });
    }

    // ============ ОТПРАВКА СООБЩЕНИЙ ============
    function initMessageForm() {
        if (!messageInput || !sendMessageBtn) return;

        // Обработчик кнопки отправки
        sendMessageBtn.addEventListener('click', sendMessage);

        // Обработчик Enter в поле ввода
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Обработчик печатания
        messageInput.addEventListener('input', () => {
            if (!currentRecipient) return;

            socket.emit('typing', {
                recipient: currentRecipient,
                is_typing: true
            });

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('typing', {
                    recipient: currentRecipient,
                    is_typing: false
                });
            }, 1000);
        });

        // Инициализация вложений
        initAttachments();
    }

    function sendMessage() {
        const messageText = messageInput ? messageInput.value.trim() : '';

        if ((!messageText && !currentAttachment) || !currentRecipient) {
            showNotification('Введите сообщение или прикрепите файл', 'info');
            return;
        }

        if (!socket.connected) {
            showNotification('Нет подключения к серверу', 'error');
            return;
        }

        let messageData = {
            recipient: currentRecipient,
            message: messageText || '',
            type: 'text'
        };

        // Если есть вложение
        if (currentAttachment) {
            messageData.type = currentAttachment.type;
            messageData.file_name = currentAttachment.file.name;
            messageData.file_size = currentAttachment.file.size;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result;
                if (base64Data.length > 50 * 1024 * 1024) {
                    showNotification('Файл слишком большой (максимум 50MB)', 'error');
                    removeAttachment();
                    return;
                }

                messageData.file_data = base64Data;
                sendMessageToServer(messageData);
            };

            reader.onerror = function() {
                showNotification('Ошибка чтения файла', 'error');
                removeAttachment();
            };

            try {
                reader.readAsDataURL(currentAttachment.file);
            } catch (error) {
                showNotification('Ошибка обработки файла', 'error');
                removeAttachment();
            }
        } else {
            sendMessageToServer(messageData);
        }

        // Сбрасываем статус "печатает"
        clearTimeout(typingTimeout);
        socket.emit('typing', {
            recipient: currentRecipient,
            is_typing: false
        });
    }

    function sendMessageToServer(messageData) {
        const originalIcon = sendMessageBtn.innerHTML;
        sendMessageBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        sendMessageBtn.disabled = true;

        socket.emit('send_message', messageData, (response) => {
            sendMessageBtn.innerHTML = originalIcon;
            sendMessageBtn.disabled = false;

            if (response && response.error) {
                showNotification('Ошибка отправки: ' + response.error, 'error');
            } else {
                if (messageInput) messageInput.value = '';
                removeAttachment();
                loadContacts();
            }
        });
    }

    // ============ ВЛОЖЕНИЯ ФАЙЛОВ ============
    function initAttachments() {
        if (attachPhotoBtn && photoInput) {
            attachPhotoBtn.addEventListener('click', () => photoInput.click());
            photoInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0], 'image'));
        }

        if (attachVideoBtn && videoInput) {
            attachVideoBtn.addEventListener('click', () => videoInput.click());
            videoInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0], 'video'));
        }

        if (attachFileBtn && fileInput) {
            attachFileBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0], 'file'));
        }

        if (removeAttachmentBtn) {
            removeAttachmentBtn.addEventListener('click', removeAttachment);
        }
    }

    function handleFileSelect(file, type) {
        if (!file) return;

        const maxSize = 50 * 1024 * 1024;
        if (file.size > maxSize) {
            showNotification('Файл слишком большой (максимум 50MB)', 'error');
            return;
        }

        if (type === 'image') {
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/bmp'];
            if (file.type && !validTypes.includes(file.type)) {
                showNotification('Неподдерживаемый формат изображения', 'error');
                return;
            }
        } else if (type === 'video') {
            const validTypes = ['video/mp4', 'video/webm', 'video/ogg', 'video/avi', 'video/mov'];
            if (file.type && !validTypes.includes(file.type)) {
                showNotification('Неподдерживаемый формат видео', 'error');
                return;
            }
        }

        currentAttachment = {
            file: file,
            type: type,
            url: URL.createObjectURL(file)
        };

        showAttachmentPreview();
    }

    function getFileIcon(file) {
        const extension = file.name.split('.').pop().toLowerCase();
        const icons = {
            pdf: '📄',
            doc: '📝', docx: '📝',
            xls: '📊', xlsx: '📊',
            zip: '🗜️', rar: '🗜️', '7z': '🗜️',
            txt: '📃',
            mp3: '🎵', wav: '🎵', flac: '🎵',
            default: '📎'
        };

        return icons[extension] || icons.default;
    }

    function showAttachmentPreview() {
        if (!attachmentPreview || !currentAttachment) return;

        attachmentPreview.style.display = 'block';

        if (currentAttachment.type === 'image') {
            previewImage.style.display = 'block';
            previewImage.innerHTML = `<img src="${currentAttachment.url}" alt="Preview">`;
            previewVideo.style.display = 'none';
            previewFile.style.display = 'none';
        } else if (currentAttachment.type === 'video') {
            previewImage.style.display = 'none';
            previewFile.style.display = 'none';
            previewVideo.style.display = 'block';
            previewVideo.innerHTML = `
                <video controls>
                    <source src="${currentAttachment.url}" type="${currentAttachment.file.type}">
                </video>
            `;
        } else {
            previewImage.style.display = 'none';
            previewVideo.style.display = 'none';
            previewFile.style.display = 'block';

            const fileIcon = getFileIcon(currentAttachment.file);
            previewFile.innerHTML = `
                <div class="file-preview">
                    <div class="file-icon">${fileIcon}</div>
                    <div class="file-info">
                        <div class="file-name">${escapeHtml(currentAttachment.file.name)}</div>
                        <div class="file-size">${formatFileSize(currentAttachment.file.size)}</div>
                    </div>
                </div>
            `;
        }

        if (previewInfo) {
            const fileType = currentAttachment.type === 'image' ? '📷' :
                           currentAttachment.type === 'video' ? '🎬' : '📎';
            previewInfo.textContent = `${fileType} ${currentAttachment.file.name} (${formatFileSize(currentAttachment.file.size)})`;
        }
    }

    function removeAttachment() {
        if (currentAttachment) {
            URL.revokeObjectURL(currentAttachment.url);
            currentAttachment = null;
        }
        if (attachmentPreview) {
            attachmentPreview.style.display = 'none';
        }
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        else return (bytes / 1048576).toFixed(1) + ' MB';
    }

    // ============ ЗАГРУЗКА И ОТОБРАЖЕНИЕ СООБЩЕНИЙ ============
    function loadMessages() {
        if (!currentRecipient) return;

        fetch(`/get_messages/${currentRecipient}`)
            .then(response => response.json())
            .then(messages => {
                allMessages = Array.isArray(messages) ? messages : [];
                displayMessages(allMessages);
            })
            .catch(error => console.error('Error loading messages:', error));
    }

    function displayMessages(messages) {
        if (!messagesContainer) return;

        messagesContainer.innerHTML = '';

        if (!messages || messages.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'empty-chat';
            emptyMessage.innerHTML = `
                <div class="empty-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <h3>Начните общение</h3>
                <p>Это начало вашего чата с ${currentRecipientName}</p>
            `;
            messagesContainer.appendChild(emptyMessage);
            return;
        }

        messages.forEach(message => {
            addMessageToDOM(message);
        });

        scrollToBottom();
    }

    function addMessageToDOM(message) {
        if (!messagesContainer) return;

        const isOutgoing = message.sender === currentUser;
        const messageElement = document.createElement('div');
        messageElement.className = `message ${isOutgoing ? 'outgoing' : 'incoming'} ${message.deleted ? 'deleted' : ''}`;
        messageElement.dataset.messageId = message.id;

        const time = formatTime(message.timestamp);
        const avatarColor = isOutgoing ? currentUserColor : currentRecipientColor;
        const avatarText = isOutgoing ? currentUserName[0].toUpperCase() : currentRecipientName[0].toUpperCase();

        let messageContent = '';

        if (message.deleted) {
            messageContent = `
                <div class="message-text deleted-text">
                    <i class="fas fa-trash"></i> Сообщение удалено${message.deleted_by !== currentUser ? ` пользователем @${message.deleted_by}` : ''}
                </div>
            `;
        } else if (message.type === 'image') {
            messageContent = `
                <div class="message-media">
                    <img src="/static/uploads/media/${message.file_path}" alt="Изображение" onclick="openMediaViewer('/static/uploads/media/${message.file_path}', 'image')">
                </div>
                ${message.message ? `<div class="media-caption">${escapeHtml(message.message)}</div>` : ''}
            `;
        } else if (message.type === 'video') {
            messageContent = `
                <div class="message-media">
                    <video controls>
                        <source src="/static/uploads/media/${message.file_path}" type="video/mp4">
                    </video>
                </div>
                ${message.message ? `<div class="media-caption">${escapeHtml(message.message)}</div>` : ''}
            `;
        } else if (message.type === 'audio') {
            messageContent = `
                <div class="message-file">
                    <div class="file-container">
                        <div class="file-icon">🎵</div>
                        <div class="file-info">
                            <div class="file-name">${escapeHtml(message.file_name)}</div>
                            <div class="file-size">${formatFileSize(message.file_size)}</div>
                        </div>
                        <audio controls>
                            <source src="/static/uploads/media/${message.file_path}" type="audio/mp3">
                        </audio>
                    </div>
                </div>
                ${message.message ? `<div class="file-caption">${escapeHtml(message.message)}</div>` : ''}
            `;
        } else if (message.type === 'file') {
            const fileIcon = getFileIcon({name: message.file_name});

            messageContent = `
                <div class="message-file">
                    <a href="/static/uploads/${message.file_path}" download="${escapeHtml(message.file_name)}"
                       class="file-container" target="_blank">
                        <div class="file-icon">${fileIcon}</div>
                        <div class="file-info">
                            <div class="file-name">${escapeHtml(message.file_name)}</div>
                            <div class="file-size">${formatFileSize(message.file_size)}</div>
                        </div>
                        <div class="file-download">
                            <i class="fas fa-download"></i>
                        </div>
                    </a>
                </div>
                ${message.message ? `<div class="file-caption">${escapeHtml(message.message)}</div>` : ''}
            `;
        } else if (message.type === 'sticker') {
            messageContent = `
                <div class="message-sticker">
                    <div class="sticker-emoji">${escapeHtml(message.message)}</div>
                </div>
            `;
        } else {
            messageContent = `<div class="message-text">${escapeHtml(message.message)}</div>`;
        }

        messageElement.innerHTML = `
            <div class="message-avatar" style="background: ${avatarColor}">
                ${avatarText}
            </div>
            <div class="message-content">
                <div class="message-bubble">
                    ${messageContent}
                    <div class="message-time">${time}</div>
                </div>
            </div>
        `;

        messagesContainer.appendChild(messageElement);
    }

    // ============ WEBSOCKET ОБРАБОТЧИКИ ============
    function handleNewMessage(message) {
        if (!message) return;

        if (message.sender === currentRecipient) {
            // Сообщение от текущего собеседника
            addMessageToDOM(message);
            allMessages.push(message);
            scrollToBottom();
            playMessageSound();
            updateLastMessagePreview(message);

            // Если окно не в фокусе, показываем уведомление сверху
            if (!isWindowFocused) {
                showTopNotification(message);
            }
        } else {
            // Сообщение от другого пользователя
            // Увеличиваем счетчик непрочитанных
            if (!unreadMessages[message.sender]) {
                unreadMessages[message.sender] = 0;
            }
            unreadMessages[message.sender]++;
            updateUnreadBadge(message.sender);

            // Показываем уведомление сверху
            showTopNotification(message);

            loadContacts();
        }
    }

    function handleMessageSent(message) {
        if (!message) return;

        if (message.recipient === currentRecipient) {
            addMessageToDOM(message);
            allMessages.push(message);
            scrollToBottom();
            loadContacts();
        }
    }

    function handleMessageEdited(data) {
        if (!data) return;

        const messageElement = document.querySelector(`[data-message-id="${data.message_id}"]`);
        if (messageElement) {
            const messageText = messageElement.querySelector('.message-text');
            if (messageText) {
                messageText.textContent = data.new_text;
            }
        }
    }

    function handleMessageDeleted(data) {
        if (!data) return;

        const messageElement = document.querySelector(`[data-message-id="${data.message_id}"]`);
        if (messageElement) {
            if (data.permanent) {
                messageElement.remove();
            } else {
                messageElement.classList.add('deleted');
                const messageBubble = messageElement.querySelector('.message-bubble');
                if (messageBubble) {
                    messageBubble.innerHTML = `
                        <div class="message-text deleted-text">
                            <i class="fas fa-trash"></i> Сообщение удалено${data.deleted_by !== currentUser ? ` пользователем @${data.deleted_by}` : ''}
                        </div>
                        <div class="message-time">Удалено</div>
                    `;
                }
            }
        }
    }

    function handleUserStatus(data) {
        if (!data) return;
        updateOnlineStatus(data.username, data.online);
    }

    function handleUserTyping(data) {
        if (!data || !typingIndicator || !typingText) return;

        if (data.username === currentRecipient && data.is_typing) {
            typingText.textContent = `${currentRecipientName} печатает...`;
            typingIndicator.style.display = 'flex';
        } else if (data.username === currentRecipient && !data.is_typing) {
            typingIndicator.style.display = 'none';
        }
    }

    // ============ СТИКЕРЫ ============
    function initStickers() {
        const stickersBtn = document.getElementById('stickers-toggle');
        if (!stickersBtn) return;

        stickersBtn.addEventListener('click', toggleStickers);

        // Создаем контейнер для стикеров
        const stickersContainer = document.createElement('div');
        stickersContainer.id = 'stickers-panel';
        stickersContainer.className = 'stickers-panel';

        stickersContainer.innerHTML = `
            <div class="stickers-header">
                <h4><i class="fas fa-sticky-note"></i> Стикеры</h4>
                <button class="btn-icon close-stickers">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sticker-categories" id="sticker-categories"></div>
            <div class="stickers-grid" id="stickers-grid"></div>
        `;

        document.body.appendChild(stickersContainer);

        // Загружаем категории
        loadStickerCategories();

        // Закрытие по крестику
        stickersContainer.querySelector('.close-stickers').addEventListener('click', closeStickers);

        // Закрытие при клике вне панели
        document.addEventListener('click', closeStickersOnClickOutside);
    }

    function loadStickerCategories() {
        const categoriesContainer = document.getElementById('sticker-categories');
        if (!categoriesContainer) return;

        categoriesContainer.innerHTML = '';

        const stickers = {
            'emotions': 'Эмоции',
            'animals': 'Животные',
            'actions': 'Действия',
            'food': 'Еда',
            'objects': 'Объекты',
            'flags': 'Флаги'
        };

        Object.keys(stickers).forEach(category => {
            const btn = document.createElement('button');
            btn.className = 'sticker-category-btn';
            btn.dataset.category = category;
            btn.innerHTML = `
                <span>${stickers[category]}</span>
            `;
            btn.addEventListener('click', () => loadStickers(category));
            categoriesContainer.appendChild(btn);
        });

        // Загружаем первую категорию
        if (Object.keys(stickers).length > 0) {
            loadStickers(Object.keys(stickers)[0]);
        }
    }

    function loadStickers(category) {
        const grid = document.getElementById('stickers-grid');
        if (!grid) return;

        grid.innerHTML = '';

        const stickerSets = {
            'emotions': ['😊', '😂', '😍', '😉', '😎', '😢', '😠', '😲', '🤔', '🤦', '😭', '😘'],
            'animals': ['🐱', '🐶', '🦊', '🦁', '🐯', '🐻', '🐼', '🐰', '🦉', '🦄', '🐵', '🐲'],
            'actions': ['👍', '👎', '👌', '👏', '🙏', '✊', '👋', '❤️', '🔥', '⭐', '🚀', '🏆'],
            'food': ['☕', '🍕', '🍺', '🎂', '🍔', '🍣', '🍦', '🍸', '🍿', '🍫'],
            'objects': ['🎁', '🎈', '🎵', '📷', '📱', '💰', '⏰', '📚', '💻', '🔑'],
            'flags': ['🇷🇺', '🇺🇸', '🇬🇧', '🇩🇪', '🇫🇷', '🇪🇸', '🇮🇹', '🇯🇵', '🇨🇳', '🇺🇦']
        };

        if (stickerSets[category]) {
            stickerSets[category].forEach(emoji => {
                const stickerEl = document.createElement('div');
                stickerEl.className = 'sticker-item';
                stickerEl.innerHTML = `
                    <div class="sticker-emoji">${emoji}</div>
                `;

                stickerEl.addEventListener('click', () => {
                    sendSticker(emoji);
                    closeStickers();
                });

                grid.appendChild(stickerEl);
            });
        }

        // Обновляем активную категорию
        document.querySelectorAll('.sticker-category-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.category === category) {
                btn.classList.add('active');
            }
        });
    }

    function toggleStickers() {
        const panel = document.getElementById('stickers-panel');
        if (!panel) return;

        if (panel.classList.contains('show')) {
            closeStickers();
        } else {
            openStickers();
        }
    }

    function openStickers() {
        const panel = document.getElementById('stickers-panel');
        if (!panel) return;

        panel.classList.add('show');
    }

    function closeStickers() {
        const panel = document.getElementById('stickers-panel');
        if (!panel) return;

        panel.classList.remove('show');
    }

    function closeStickersOnClickOutside(event) {
        const panel = document.getElementById('stickers-panel');
        const stickersBtn = document.getElementById('stickers-toggle');

        if (!panel || !stickersBtn) return;

        if (!panel.contains(event.target) && !stickersBtn.contains(event.target)) {
            closeStickers();
        }
    }

    function sendSticker(emoji) {
        if (!currentRecipient) {
            showNotification('Выберите чат для отправки стикера', 'info');
            return;
        }

        const messageData = {
            recipient: currentRecipient,
            message: emoji,
            type: 'sticker'
        };

        const originalIcon = sendMessageBtn.innerHTML;
        sendMessageBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        sendMessageBtn.disabled = true;

        socket.emit('send_message', messageData, (response) => {
            sendMessageBtn.innerHTML = originalIcon;
            sendMessageBtn.disabled = false;

            if (response && response.error) {
                showNotification('Ошибка отправки: ' + response.error, 'error');
            }
        });
    }

    // ============ УВЕДОМЛЕНИЯ СВЕРХУ ============
    function showTopNotification(message) {
        // Получаем информацию об отправителе
        fetch(`/api/user/${message.sender}`)
            .then(response => response.json())
            .then(user => {
                if (user.error) return;

                const notification = document.createElement('div');
                notification.className = 'new-message-notification';

                // Определяем цвет аватарки
                let avatarColor = user.avatar_color || '#4ECDC4';
                if (message.sender === currentRecipient) {
                    avatarColor = currentRecipientColor;
                }

                let messageText = '';
                if (message.type === 'image') {
                    messageText = '📷 Изображение';
                } else if (message.type === 'video') {
                    messageText = '🎬 Видео';
                } else if (message.type === 'sticker') {
                    messageText = '😊 Стикер';
                } else if (message.type === 'file') {
                    messageText = '📎 Файл';
                } else if (message.type === 'audio') {
                    messageText = '🎵 Аудио';
                } else {
                    messageText = message.message.length > 30 ?
                        message.message.substring(0, 30) + '...' :
                        message.message;
                }

                notification.innerHTML = `
                    <div class="notification-avatar" style="background: ${avatarColor}">
                        ${user.name[0].toUpperCase()}
                    </div>
                    <div class="notification-content">
                        <div class="notification-sender">${escapeHtml(user.name)}</div>
                        <div class="notification-message">${escapeHtml(messageText)}</div>
                    </div>
                    <button class="notification-close">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                // Обработчик закрытия
                notification.querySelector('.notification-close').addEventListener('click', () => {
                    notification.remove();
                });

                // Обработчик клика по уведомлению
                notification.addEventListener('click', () => {
                    openChat(message.sender, user.name, avatarColor);
                    notification.remove();
                });

                // Автоматическое скрытие через 5 секунд
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);

                // Удаляем старое уведомление, если есть
                const oldNotification = document.querySelector('.new-message-notification');
                if (oldNotification) {
                    oldNotification.remove();
                }

                document.body.appendChild(notification);
            })
            .catch(console.error);
    }

    function updateUnreadBadge(username) {
        const contactItem = document.querySelector(`.contact-item[data-username="${username}"]`);
        if (contactItem) {
            let badge = contactItem.querySelector('.unread-badge');
            const unreadCount = unreadMessages[username] || 0;

            if (unreadCount > 0) {
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'unread-badge';
                    contactItem.appendChild(badge);
                }
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
                badge.style.display = 'block';
            } else if (badge) {
                badge.style.display = 'none';
            }
        }
    }

    // ============ ЗВОНКИ ============
    function initCallSystem() {
        // Обработчики кнопок звонка
        document.addEventListener('click', function(e) {
            if (e.target.closest('#accept-call-btn')) acceptCall();
            if (e.target.closest('#reject-call-btn')) rejectCall();
            if (e.target.closest('#end-call-btn')) endCall();
            if (e.target.closest('#mute-audio-btn')) toggleMuteAudio();
            if (e.target.closest('#mute-video-btn')) toggleMuteVideo();
        });
    }

    async function startCall(type) {
        if (!currentRecipient) {
            showNotification('Выберите пользователя для звонка', 'error');
            return;
        }

        if (activeCall) {
            showNotification('Уже есть активный звонок', 'error');
            return;
        }

        try {
            const constraints = {
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                    sampleRate: 48000,
                    channelCount: 1
                },
                video: type === 'video' ? {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    frameRate: { ideal: 30 }
                } : false
            };

            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            console.log('Локальный поток получен:', localStream.getAudioTracks().length, 'аудио дорожек');

            const callId = 'call_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            activeCall = {
                id: callId,
                type: type,
                caller: currentUser,
                callee: currentRecipient,
                status: 'calling',
                direction: 'outgoing'
            };

            showCallInterface('outgoing');

            socket.emit('start_call', {
                to: currentRecipient,
                call_id: callId,
                call_type: type
            });

            // Таймаут звонка
            setTimeout(() => {
                if (activeCall && activeCall.status === 'calling') {
                    endCall();
                    showNotification('Пользователь не отвечает', 'error');
                }
            }, 30000);

        } catch (error) {
            console.error('Ошибка доступа к медиаустройствам:', error);
            showNotification('Ошибка доступа к камере/микрофону', 'error');
            resetCall();
        }
    }

    function handleIncomingCall(data) {
        if (activeCall) {
            socket.emit('reject_call', {
                call_id: data.call_id,
                reason: 'Busy'
            });
            return;
        }

        activeCall = {
            id: data.call_id,
            type: data.type,
            caller: data.caller,
            callee: currentUser,
            status: 'ringing',
            direction: 'incoming'
        };

        showCallInterface('incoming');

        // Автоотклонение через 45 секунд
        setTimeout(() => {
            if (activeCall && activeCall.status === 'ringing') {
                rejectCall();
            }
        }, 45000);
    }

    async function acceptCall() {
        if (!activeCall || activeCall.status !== 'ringing') return;

        try {
            const constraints = {
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                },
                video: activeCall.type === 'video' ? {
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                } : false
            };

            localStream = await navigator.mediaDevices.getUserMedia(constraints);

            activeCall.status = 'active';
            showCallInterface('active');

            socket.emit('accept_call', {
                call_id: activeCall.id
            });

            createPeerConnection();
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            const offer = await peerConnection.createOffer({
                offerToReceiveAudio: true,
                offerToReceiveVideo: activeCall.type === 'video'
            });
            await peerConnection.setLocalDescription(offer);

            socket.emit('webrtc_signal', {
                to: activeCall.caller,
                call_id: activeCall.id,
                signal: offer
            });

        } catch (error) {
            console.error('Ошибка при принятии звонка:', error);
            showNotification('Ошибка при запуске камеры/микрофона', 'error');
            endCall();
        }
    }

    function rejectCall() {
        if (!activeCall) return;

        if (activeCall.direction === 'incoming') {
            socket.emit('reject_call', {
                call_id: activeCall.id,
                reason: 'User rejected'
            });
        }

        resetCall();
        showNotification('Звонок отклонен', 'info');
    }

    function endCall() {
        if (!activeCall) return;

        const callDuration = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;

        socket.emit('end_call', {
            call_id: activeCall.id,
            duration: callDuration
        });

        resetCall();
    }

    function handleCallAccepted(data) {
        if (!activeCall || activeCall.id !== data.call_id) return;

        activeCall.status = 'active';
        showCallInterface('active');

        createPeerConnection();
        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });

        peerConnection.createOffer({
            offerToReceiveAudio: true,
            offerToReceiveVideo: activeCall.type === 'video'
        })
            .then(offer => peerConnection.setLocalDescription(offer))
            .then(() => {
                socket.emit('webrtc_signal', {
                    to: activeCall.callee,
                    call_id: activeCall.id,
                    signal: peerConnection.localDescription
                });
            });
    }

    function handleCallRejected(data) {
        if (!activeCall || activeCall.id !== data.call_id) return;
        showNotification('Пользователь отклонил звонок', 'error');
        resetCall();
    }

    function handleCallEnded(data) {
        if (!activeCall || activeCall.id !== data.call_id) return;

        const duration = data.duration || 0;
        const message = duration > 0 ?
            `Звонок завершен. Длительность: ${formatDuration(duration)}` :
            'Звонок завершен';

        showNotification(message, 'info');
        resetCall();
    }

    function handleCallTimeout(data) {
        if (!activeCall || activeCall.id !== data.call_id) return;
        showNotification('Пользователь не ответил', 'error');
        resetCall();
    }

    function handleCallError(data) {
        showNotification(`Ошибка звонка: ${data.message}`, 'error');
        resetCall();
    }

    function handleWebRTCSignal(data) {
        if (!activeCall || activeCall.id !== data.call_id || !peerConnection) return;

        const signal = data.signal;

        if (signal.type === 'offer') {
            peerConnection.setRemoteDescription(new RTCSessionDescription(signal))
                .then(() => peerConnection.createAnswer())
                .then(answer => peerConnection.setLocalDescription(answer))
                .then(() => {
                    socket.emit('webrtc_signal', {
                        to: data.from,
                        call_id: activeCall.id,
                        signal: peerConnection.localDescription
                    });
                })
                .catch(error => console.error('Ошибка обработки offer:', error));
        } else if (signal.type === 'answer') {
            peerConnection.setRemoteDescription(new RTCSessionDescription(signal))
                .catch(error => console.error('Ошибка установки answer:', error));
        }
    }

    function handleCallIceCandidate(data) {
        if (!activeCall || activeCall.id !== data.call_id || !peerConnection) return;

        const candidate = new RTCIceCandidate(data.candidate);
        peerConnection.addIceCandidate(candidate)
            .catch(error => console.error('Ошибка добавления ICE кандидата:', error));
    }

    function createPeerConnection() {
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' }
            ],
            iceCandidatePoolSize: 10
        };

        peerConnection = new RTCPeerConnection(configuration);

        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                const recipient = activeCall.direction === 'outgoing' ? activeCall.callee : activeCall.caller;
                socket.emit('call_ice_candidate', {
                    to: recipient,
                    call_id: activeCall.id,
                    candidate: event.candidate
                });
            }
        };

        peerConnection.ontrack = (event) => {
            console.log('Получен удаленный поток:', event.streams[0]);
            remoteStream = event.streams[0];
            if (remoteVideo) {
                remoteVideo.srcObject = remoteStream;
                remoteVideo.onloadedmetadata = () => {
                    console.log('Удаленное видео загружено');
                    remoteVideo.play().catch(e => console.error('Ошибка воспроизведения:', e));
                };
            }
        };

        peerConnection.onconnectionstatechange = () => {
            console.log('Состояние соединения:', peerConnection.connectionState);
            if (peerConnection.connectionState === 'failed') {
                showNotification('Ошибка соединения', 'error');
                endCall();
            } else if (peerConnection.connectionState === 'connected') {
                console.log('Соединение установлено!');
            }
        };

        peerConnection.oniceconnectionstatechange = () => {
            console.log('ICE состояние:', peerConnection.iceConnectionState);
        };
    }

    function showCallInterface(type) {
        if (!callModal) return;

        callModal.style.display = 'flex';

        if (type === 'outgoing') {
            callTitle.textContent = 'Исходящий звонок';
            callStatus.textContent = 'Звонок пользователю...';
            callWith.textContent = currentRecipientName;
            acceptCallBtn.style.display = 'none';
            rejectCallBtn.style.display = 'none';
            endCallBtn.style.display = 'block';
            muteAudioBtn.style.display = 'none';
            muteVideoBtn.style.display = 'none';

            if (localStream && activeCall.type === 'video') {
                localVideo.srcObject = localStream;
                localVideo.style.display = 'block';
            } else {
                localVideo.style.display = 'none';
            }
            remoteVideo.style.display = 'none';

        } else if (type === 'incoming') {
            callTitle.textContent = 'Входящий звонок';
            callStatus.textContent = 'Вам звонят...';
            callWith.textContent = activeCall.caller;
            acceptCallBtn.style.display = 'block';
            rejectCallBtn.style.display = 'block';
            endCallBtn.style.display = 'none';
            muteAudioBtn.style.display = 'none';
            muteVideoBtn.style.display = 'none';

            localVideo.style.display = 'none';
            remoteVideo.style.display = 'none';

        } else if (type === 'active') {
            callTitle.textContent = 'Звонок';
            callStatus.textContent = 'Разговор';
            callWith.textContent = activeCall.direction === 'outgoing' ? currentRecipientName : activeCall.caller;
            acceptCallBtn.style.display = 'none';
            rejectCallBtn.style.display = 'none';
            endCallBtn.style.display = 'block';
            muteAudioBtn.style.display = 'block';
            muteVideoBtn.style.display = activeCall.type === 'video' ? 'block' : 'none';

            if (localStream) {
                localVideo.srcObject = localStream;
                localVideo.style.display = activeCall.type === 'video' ? 'block' : 'none';
                localVideo.play().catch(e => console.error('Ошибка воспроизведения локального видео:', e));
            }
            remoteVideo.style.display = activeCall.type === 'video' ? 'block' : 'none';

            startCallTimer();
        }
    }

    function startCallTimer() {
        callStartTime = Date.now();
        if (callTimer) clearInterval(callTimer);

        callTimer = setInterval(() => {
            const elapsed = Date.now() - callStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const timerStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (callTimerElement) {
                callTimerElement.textContent = timerStr;
            }
        }, 1000);
    }

    function toggleMuteAudio() {
        if (!localStream) return;

        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            isMuted = !audioTrack.enabled;

            if (muteAudioBtn) {
                muteAudioBtn.innerHTML = isMuted ?
                    '<i class="fas fa-microphone-slash"></i>' :
                    '<i class="fas fa-microphone"></i>';
            }
        }
    }

    function toggleMuteVideo() {
        if (!localStream || activeCall.type !== 'video') return;

        const videoTrack = localStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            isVideoMuted = !videoTrack.enabled;

            if (muteVideoBtn) {
                muteVideoBtn.innerHTML = isVideoMuted ?
                    '<i class="fas fa-video-slash"></i>' :
                    '<i class="fas fa-video"></i>';
            }
        }
    }

    function resetCall() {
        if (callTimer) {
            clearInterval(callTimer);
            callTimer = null;
        }

        callStartTime = null;

        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }

        if (remoteStream) {
            remoteStream.getTracks().forEach(track => track.stop());
            remoteStream = null;
        }

        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }

        activeCall = null;
        isMuted = false;
        isVideoMuted = false;

        if (callModal) {
            callModal.style.display = 'none';
        }
    }

    // ============ ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ============
    function updateOnlineStatus(username, isOnline) {
        const statusIndicator = document.getElementById(`status-${username}`);
        const headerStatusIndicator = document.getElementById(`header-status-${username}`);
        const headerStatusText = document.getElementById(`header-status-text-${username}`);

        if (statusIndicator) statusIndicator.classList.toggle('online', isOnline);
        if (headerStatusIndicator) headerStatusIndicator.classList.toggle('online', isOnline);
        if (headerStatusText) {
            const status = isOnline ? 'онлайн' : 'офлайн';
            const iconColor = isOnline ? '#10b981' : '#94a3b8';
            headerStatusText.innerHTML = `<i class="fas fa-circle" style="color: ${iconColor}"></i> ${status}`;
        }

        updateOnlineCount();
    }

    function checkOnlineStatus(username) {
        fetch('/get_online_status')
            .then(response => response.json())
            .then(onlineUsers => {
                const userStatus = onlineUsers[username];
                if (userStatus) {
                    updateOnlineStatus(username, userStatus.online);
                }
            })
            .catch(console.error);
    }

    function updateOnlineCount() {
        const onlineItems = document.querySelectorAll('.status-indicator.online');
        const count = onlineItems.length;
        if (onlineCount) onlineCount.textContent = `${count}`;
    }

    function updateLastMessagePreview(message) {
        const contactItem = document.querySelector(`.contact-item[data-username="${message.sender}"]`);
        if (contactItem) {
            const previewElement = contactItem.querySelector('.contact-preview');
            if (previewElement) {
                let shortMessage = '';
                if (message.type === 'image') shortMessage = '📷 Изображение';
                else if (message.type === 'video') shortMessage = '🎬 Видео';
                else if (message.type === 'audio') shortMessage = '🎵 Аудио';
                else if (message.type === 'file') shortMessage = '📎 Файл';
                else if (message.type === 'sticker') shortMessage = '😊 Стикер';
                else shortMessage = message.message.length > 30 ? message.message.substring(0, 30) + '...' : message.message;

                previewElement.textContent = shortMessage;
            }
        }
    }

    function toggleBlockUser() {
        if (!currentRecipient) return;

        const isBlocked = confirm(`Вы уверены, что хотите заблокировать пользователя @${currentRecipient}?`);

        if (isBlocked) {
            fetch('/api/block_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username: currentRecipient })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification(result.message, 'success');
                    updateChatHeader();
                    loadContacts();
                } else {
                    showNotification(result.message, 'error');
                }
            });
        }
    }

    function scrollToBottom() {
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }

    function playMessageSound() {
        try {
            const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
            audio.volume = 0.1;
            audio.play();
        } catch (e) {}
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;

        let icon = 'info-circle';
        if (type === 'success') icon = 'check-circle';
        if (type === 'error') icon = 'exclamation-circle';

        notification.innerHTML = `
            <i class="fas fa-${icon}"></i>
            <span>${message}</span>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.classList.add('show');
        }, 10);

        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    function formatTime(timestamp) {
        if (!timestamp) return '';
        try {
            const date = new Date(timestamp);
            const now = new Date();

            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return 'Вчера';
            }

            const diff = now - date;
            if (diff < 7 * 24 * 60 * 60 * 1000) {
                const days = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
                return days[date.getDay()];
            }

            return date.toLocaleDateString([], { day: '2-digit', month: '2-digit' });
        } catch (e) {
            return '';
        }
    }

    function formatDuration(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        if (hours > 0) {
            return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // ============ ОТСЛЕЖИВАНИЕ ФОКУСА ОКНА ============
    function initWindowFocusTracking() {
        window.addEventListener('focus', () => {
            isWindowFocused = true;
        });

        window.addEventListener('blur', () => {
            isWindowFocused = false;
        });

        // Также отслеживаем видимость страницы
        document.addEventListener('visibilitychange', () => {
            isWindowFocused = !document.hidden;
        });
    }

    // ============ ГЛОБАЛЬНЫЕ ФУНКЦИИ ДЛЯ МЕДИА ============
    window.openMediaViewer = function(url, type) {
        const viewer = document.createElement('div');
        viewer.className = 'media-viewer';
        viewer.innerHTML = `
            <div class="media-viewer-content">
                <button class="close-viewer" onclick="window.closeMediaViewer()">
                    <i class="fas fa-times"></i>
                </button>
                ${type === 'image'
                    ? `<img src="${url}" alt="Изображение">`
                    : `<video controls autoplay>
                          <source src="${url}" type="video/mp4">
                       </video>`
                }
            </div>
        `;
        document.body.appendChild(viewer);
    };

    window.closeMediaViewer = function() {
        const viewer = document.querySelector('.media-viewer');
        if (viewer) {
            document.body.removeChild(viewer);
        }
    };

    // ============ ИНИЦИАЛИЗАЦИЯ ============
    initWebSocket();
    initSearch();
    initMessageForm();
    initCallSystem();
    initStickers();
    initWindowFocusTracking();

    // Загрузка контактов
    loadContacts();

    // Клики по контактам
    if (contactsList) {
        contactsList.addEventListener('click', (e) => {
            const contactItem = e.target.closest('.contact-item');
            if (contactItem) {
                const username = contactItem.dataset.username;
                const name = contactItem.querySelector('h4').textContent;
                const color = contactItem.dataset.color || '#4ECDC4';
                openChat(username, name, color);
            }
        });
    }

    // Кнопка "Найти пользователя"
    const startNewChatBtn = document.getElementById('start-new-chat');
    if (startNewChatBtn) {
        startNewChatBtn.addEventListener('click', () => {
            if (searchInput) searchInput.focus();
        });
    }

    console.log('Kildear Messenger инициализирован');
});